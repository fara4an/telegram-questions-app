// –í src/bot.js –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ /start –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É tos:

bot.start(async (ctx) => {
    const userId = ctx.from.id;
    const firstName = ctx.from.first_name || '–¥—Ä—É–≥';
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å start payload (–∫—Ç–æ-—Ç–æ –ø–µ—Ä–µ—à–µ–ª –ø–æ —Å—Å—ã–ª–∫–µ)
    if (ctx.startPayload && ctx.startPayload.startsWith('ask_')) {
        const targetUserId = ctx.startPayload.replace('ask_', '');
        
        // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ü–†–ò–í–ï–¢–°–¢–í–ò–ï —Å –±–æ–ª—å—à–æ–π –∫–Ω–æ–ø–∫–æ–π
        await ctx.reply(
            `üëã *${firstName}, –ø—Ä–∏–≤–µ—Ç!*\n\n` +
            `–¢—ã –ø–µ—Ä–µ—à—ë–ª –ø–æ —Å—Å—ã–ª–∫–µ, —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å *–∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤–æ–ø—Ä–æ—Å*.\n\n` +
            `–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá —á—Ç–æ–±—ã *—Å—Ä–∞–∑—É –Ω–∞–ø–∏—Å–∞—Ç—å –≤–æ–ø—Ä–æ—Å*:`,
            {
                parse_mode: 'Markdown',
                reply_markup: {
                    inline_keyboard: [
                        [
                            {
                                text: '‚úçÔ∏è –ù–ê–ü–ò–°–ê–¢–¨ –ê–ù–û–ù–ò–ú–ù–´–ô –í–û–ü–†–û–°',
                                web_app: { 
                                    url: `${process.env.WEB_APP_URL}/ask/${targetUserId}?from=telegram` 
                                }
                            }
                        ],
                        [
                            {
                                text: '‚ùì –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?',
                                callback_data: 'how_it_works'
                            },
                            {
                                text: 'üì± –û—Ç–∫—Ä—ã—Ç—å —Å–≤–æ—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
                                web_app: { url: process.env.WEB_APP_URL }
                            }
                        ]
                    ]
                }
            }
        );
        
        // 2. –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        setTimeout(async () => {
            try {
                await ctx.reply(
                    `*üìå –í—Å—ë –ø—Ä–æ—Å—Ç–æ:*\n\n` +
                    `1. –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É "–ù–ê–ü–ò–°–ê–¢–¨ –ê–ù–û–ù–ò–ú–ù–´–ô –í–û–ü–†–û–°"\n` +
                    `2. –í –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –æ–∫–Ω–µ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å\n` +
                    `3. –ù–∞–∂–º–∏ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ"\n` +
                    `4. –ì–æ—Ç–æ–≤–æ! –í–æ–ø—Ä–æ—Å –ø—Ä–∏–¥—ë—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—é\n\n` +
                    `*üîí –ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞!*`,
                    { parse_mode: 'Markdown' }
                );
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
            }
        }, 2000);
        
    } else {
        // –û–±—ã—á–Ω—ã–π —Å—Ç–∞—Ä—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userLink = `https://t.me/${ctx.botInfo.username}?start=ask_${userId}`;
        
        await ctx.reply(
            `üëã *–ü—Ä–∏–≤–µ—Ç, ${firstName}!*\n\n` +
            `*–¢–≤–æ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤:*\n\`${userLink}\`\n\n` +
            `*–û—Ç–ø—Ä–∞–≤—å —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º* üëá\n` +
            `–û–Ω–∏ —Å–º–æ–≥—É—Ç –∑–∞–¥–∞—Ç—å —Ç–µ–±–µ –≤–æ–ø—Ä–æ—Å *–∞–Ω–æ–Ω–∏–º–Ω–æ*!`,
            {
                parse_mode: 'Markdown',
                reply_markup: {
                    inline_keyboard: [
                        [
                            {
                                text: 'üì± –û–¢–ö–†–´–¢–¨ –ú–û–Å –ü–†–ò–õ–û–ñ–ï–ù–ò–ï',
                                web_app: { url: process.env.WEB_APP_URL }
                            }
                        ],
                        [
                            {
                                text: 'üì§ –ü–û–î–ï–õ–ò–¢–¨–°–Ø –°–°–´–õ–ö–û–ô',
                                url: `https://t.me/share/url?url=${encodeURIComponent(userLink)}&text=–ó–∞–¥–∞–π%20–º–Ω–µ%20–∞–Ω–æ–Ω–∏–º–Ω—ã–π%20–≤–æ–ø—Ä–æ—Å!`
                            }
                        ]
                    ]
                }
            }
        );
    }
});

// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è
bot.command('tos', async (ctx) => {
    const tosText = `*üìù –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–û–ï –°–û–ì–õ–ê–®–ï–ù–ò–ï*\n\n` +
                   `*1. –û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è*\n` +
                   `1.1. –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–¥–∞–≤–∞—Ç—å –∞–Ω–æ–Ω–∏–º–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.\n` +
                   `1.2. –ò—Å–ø–æ–ª—å–∑—É—è —Å–µ—Ä–≤–∏—Å, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –≤–∞–º –µ—Å—Ç—å 16 –ª–µ—Ç.\n\n` +
                   `*2. –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*\n` +
                   `2.1. –ù–µ –Ω–∞—Ä—É—à–∞—Ç—å –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ –†–§.\n` +
                   `2.2. –ù–µ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.\n` +
                   `2.3. –ù–µ –æ—Å–∫–æ—Ä–±–ª—è—Ç—å –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n\n` +
                   `*3. –ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å*\n` +
                   `3.1. –í–æ–ø—Ä–æ—Å—ã –∑–∞–¥–∞—é—Ç—Å—è –∞–Ω–æ–Ω–∏–º–Ω–æ.\n` +
                   `3.2. –ú—ã –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π.\n\n` +
                   `*4. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å*\n` +
                   `4.1. –í—ã –Ω–µ—Å–µ—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã.\n` +
                   `4.2. –ó–∞ –Ω–∞—Ä—É—à–µ–Ω–∏—è - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞.\n\n` +
                   `*5. –ö–æ–Ω—Ç–∞–∫—Ç—ã*\n` +
                   `–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º: @questionstg`;
    
    await ctx.reply(tosText, {
        parse_mode: 'Markdown',
        reply_markup: {
            inline_keyboard: [
                [
                    {
                        text: '‚úÖ –Ø –ø—Ä–∏–Ω–∏–º–∞—é —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ',
                        callback_data: 'accept_tos_command'
                    }
                ]
            ]
        }
    });
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–∏–Ω—è—Ç–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –∏–∑ –∫–æ–º–∞–Ω–¥—ã /tos
bot.action('accept_tos_command', async (ctx) => {
    try {
        await ctx.answerCbQuery();
        
        const userId = ctx.from.id;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        const db = require('./db'); // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –µ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
        
        await db.query(
            `UPDATE users SET agreed_tos = TRUE WHERE telegram_id = $1`,
            [userId]
        );
        
        await ctx.reply(
            `‚úÖ *–°–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ!*\n\n` +
            `–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.\n\n` +
            `–í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n` +
            `\`https://t.me/${ctx.botInfo.username}?start=ask_${userId}\``,
            {
                parse_mode: 'Markdown',
                reply_markup: {
                    inline_keyboard: [
                        [
                            {
                                text: 'üì± –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
                                web_app: { url: process.env.WEB_APP_URL }
                            }
                        ]
                    ]
                }
            }
        );
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º
        try {
            await ctx.deleteMessage();
        } catch (e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —É–¥–∞–ª–µ–Ω–∏—è
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è TOS:', error);
        await ctx.answerCbQuery('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ');
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?"
bot.action('how_it_works', async (ctx) => {
    await ctx.answerCbQuery();
    await ctx.reply(
        `*üìå –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã–π –≤–æ–ø—Ä–æ—Å:*\n\n` +
        `1. –¢—ã –ø–æ–ª—É—á–∞–µ—à—å —Å—Å—ã–ª–∫—É –¥—Ä—É–≥–∞\n` +
        `2. –ü–µ—Ä–µ—Ö–æ–¥–∏—à—å –ø–æ —Å—Å—ã–ª–∫–µ (—Ç—ã –∑–¥–µ—Å—å)\n` +
        `3. –ù–∞–∂–∏–º–∞–µ—à—å "–ù–ê–ü–ò–°–ê–¢–¨ –ê–ù–û–ù–ò–ú–ù–´–ô –í–û–ü–†–û–°"\n` +
        `4. –ü–∏—à–µ—à—å –≤–æ–ø—Ä–æ—Å –≤ –æ—Ç–∫—Ä—ã–≤—à–µ–π—Å—è —Ñ–æ—Ä–º–µ\n` +
        `5. –ù–∞–∂–∏–º–∞–µ—à—å "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ"\n\n` +
        `*–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–∞–ª—å—à–µ:*\n` +
        `‚úÖ –í–æ–ø—Ä–æ—Å *–∞–Ω–æ–Ω–∏–º–Ω–æ* –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—é\n` +
        `‚úÖ –û–Ω –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram\n` +
        `‚úÖ –û–Ω –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏\n` +
        `‚úÖ –û—Ç–≤–µ—Ç –ø—Ä–∏–¥—ë—Ç —Ç–µ–±–µ (–µ—Å–ª–∏ —Ç—ã –Ω–µ –∞–Ω–æ–Ω–∏–º)\n\n` +
        `*üîí –ê–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å:*\n` +
        `‚Ä¢ –ü–æ–ª—É—á–∞—Ç–µ–ª—å *–Ω–µ —É–≤–∏–¥–∏—Ç* —Ç–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å\n` +
        `‚Ä¢ –ú–æ–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤\n` +
        `‚Ä¢ –í–æ–ø—Ä–æ—Å—ã —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è`,
        { parse_mode: 'Markdown' }
    );
});

// –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É help —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–æ–≥–ª–∞—à–µ–Ω–∏–∏
bot.command('help', async (ctx) => {
    await ctx.reply(
        `*üÜò –ü–æ–º–æ—â—å*\n\n` +
        `*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n` +
        `/start - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n` +
        `/app - –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n` +
        `/tos - –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ\n` +
        `/help - –≠—Ç–æ —Å–ø—Ä–∞–≤–∫–∞\n\n` +
        `*–î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—è:*\n` +
        `1. –ù–∞–∂–º–∏—Ç–µ /tos\n` +
        `2. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ\n` +
        `3. –ù–∞–∂–º–∏—Ç–µ "‚úÖ –Ø –ø—Ä–∏–Ω–∏–º–∞—é —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ"\n\n` +
        `*–ü—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–æ–º?*\n` +
        `–ù–∞–ø–∏—à–∏—Ç–µ –≤ @questionstg`,
        { parse_mode: 'Markdown' }
    );
});